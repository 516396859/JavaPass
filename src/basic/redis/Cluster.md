---
title: Redis 集群
icon: file
order: 2
author: Ms.Cheney
date: 2023-10-19
PageView: true
lastUpdated: true
category:
    - 中间件
copyright: false
footer: 赣ICP备2023007682 | 使用 <a href="https://theme-hope.vuejs.press/zh/" target="_blank">VuePress Theme Hope</a> 主题 | MIT 协议, 版权所有 © 2023-Cheney,2018-present Mr.Hope
# 版权声明：本文为JavaPass博主「javapass.cn」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
--- 

### 1. `Redis`的故障发现的原理知道吗？:star::star::star::four:
`Redis`集群内节点通过`ping/pong`消息实现节点通信，集群中每个节点都会定期向其他节点发送`ping`消息，接收节点回复`pong` 消息作为响应。如果在`cluster-node-timeout`时间内通信一直失败，则发送节点会认为接收节点存在故障，把接收节点标记为主观下线（`pfail`）状态。  当某个节点判断另一个节点主观下线后，相应的节点状态会跟随消息在集群内传播。通过`Gossip`消息传播，集群内节点不断收集到故障节点的下线报告。当 半数以上持有槽的主节点都标记某个节点是主观下线时。触发客观下线流程。 

**题评：** 无
::: details 点击查看详细答案
待补充
:::

### 2. `Redis` `Cluster` 集群方案什么情况下会导致整个集群不可用？:star::star::star::four:
`Redis` 没有使用哈希一致性算法，而是使用哈希槽。`Redis` 中的哈希槽一共有 `16384` 个，计算给定密钥的哈希槽，我们只需要对密钥的 `CRC16` 取摸 `16384`。假设集群中有 `A`、`B`、`C` 三个集群节点，不存在复制模式下，每个集群的节点包含的哈希槽如下：节点 `A` 包含从 `0` 到 `5500` 的哈希槽；节点 `B` 包含从 `5501` 到 `11000` 的哈希槽；节点 `C` 包含从 `11001` 到 `16383` 的哈希槽；这时，如果节点 `B` 出现故障，整个集群就会出现缺少 `5501` 到 `11000` 的哈希槽范围而不可用。

**题评：** 无
::: details 点击查看详细答案
待补充
:::

### 3. 为什么要用缓存，用缓存带来什么问题？:star::star::star::three:
缓存带来高并发（多）、高性能（快），上万`QPS`轻轻松松。带来了雪崩、穿透、数据一致性等问题。

**题评：** 无
::: details 点击查看详细答案
待补充
:::

### 4. 是否使用过 `Redis` `Cluster` 集群，集群的原理是什么？  :star::star::star::four:
每个集群节点中都有一个主节点和多个从节点，`Cluster`不需要哨兵，因为各个集群的主节点相互通信来确认存活。各个节点的联通是通过 `CLUSTER` `MEET` 命令完成的。将所有的存储空间计划切割成`16384`份，每个集群主机保存一部分注意：每份代表的是一个存储空间，不是一个`key`的保存空间。`Redis` 集群中内置了 `16384` 个哈希槽，当需要在 `Redis` 集群中放置一个 `key`-`value` 时，`redis` 先对`key` 使用 `crc16` 算法算出一个结果，然后把结果对 `16384` 求余数，这样每个 `key` 都会对应一个编号在 `0`~`16383` 之间的哈希槽，`redis` 会根据节点数量大致均等的将哈希槽映射到不同的节点。  各个数据库相互通信，保存各个库中槽的编号数据 。集群节点不会代理查询 ，集群节点挂掉会自动故障转移 。

**题评：** 无
::: details 点击查看详细答案
待补充
:::


### 5. 什么是`setinel`，`sentinel` 有啥用？:star::star::star::two:
监控各个节点的节点，当`master`出现了故障会重新选择新的`master`进行故障转移，然后通知其他`slave`新的`master`的连接信息。

**题评：** 无
::: details 点击查看详细答案
待补充
:::

### 6. 如何检测节点是否下线？:star::star::star::three:
采用的是心跳机制哨兵向各个节点发生`PING`命令，分为主观下线和客观下线；主观下线是某个`Sentinal`节点认为下线了是主观下线，客观下线是指定是法定数量（数量过半）的哨兵节点认为某个节点已经下线那就是客观下线；只有客观下线了才会选择新的`master`。

**题评：** 无
::: details 点击查看详细答案
待补充
:::

### 7. `Sentinel` 优先选择什么样的`master`?:star::star::three:
按照优先级选择：优先在线的->备份最完整的->`runid`最小的，还可以设置`slave`优先级

**题评：** 无
::: details 点击查看详细答案
待补充
:::

### 8. 如何从 `Sentinel` 集群中选择出 `Leader` ？:star::star::four:
使用的是分布式领域的`Raft`共识算法。参考详细答案！

**题评：** 无
::: details 点击查看详细答案
`Reft` 算法是分布式架构下的共识算法，用来选出主节点然后向其他节点发送指令完成数据同步，例如`Redis` `Cluster`，`Nacos`、`RabbitMQ`等集群都是通过`Reft`算法来确认`master`的。首先明确几个概念：
- 一开始每个节点都应该是平等的。
- 节点状态分为 领导者，追随者，候选者。
- 使用 `term` 任期表示一个阶段担任主节点的时间段，计数器。
- 每个追随者等待领导者心跳回应的超时时间是随机的。（降低同时成为候选者的几率）
假设有`A`，`B`，`C`节点，超时时间分别是`100ms`，`200ms`，`300ms`

投票阶段：
- 首先没有领导者，`A`会先超时，此时`A`成为候选者，然后将`term`+`1`，给其他节点发出投票请求并给自己投票。向远程的其他节点发起`RPC`投票请求。
- 其他节点在此任期内如果没有投过票，就把票投给`A`，并将任期也加一。
- 当节点`A`的票数大于等于 `n`/`2`+`1` 时成为领导者，选举完成。
- `A`作为领导者需要每隔固定时间给其他追随者发送心跳信息，确认子节点或者。
- 当子节点在一个超时时间内没收到`A`的心跳信息，则开始造反，成为候选者开启选举。
注意：任期是自增的，投票有限投给任期大的，当一个主节点宕机恢复后如果任期比新的心跳信息节点任期小则自动成为它的追随者。一般出现在分区错误恢复后。节点接到投票请求发现比自己的任期还小则投拒绝票。只能是主节点宕机或者网络延迟了，其他追随者超时才能成为候选者。如果两个节点同时成为候选者则比票数，票数一样则继续纠缠，直到其他追随者也超时开启新的任期成为新的领导者。如果由于网络延时导致节点造反，那么当它收到`pong`后，发现对方的任期>=自己的任期就回退为追随者。
:::

### 9. 为什么需要 Redis Cluster？Redis Cluster集群与Sentinel 集群区别!
现在的数据量太大了，单机存不下，而且Sentinel只有一个主节点其他都是从节点用于备份的，保证的是高可用性。Cluster每个小群都有一个主，存放不同的数据，有不同的哈希槽，用于扩展数据，保证数据的高扩展性与高可用性。
**题评：** 暂无
::: details 点击查看详细答案
待补充
:::


### 10. Redis Cluster 是如何分片的？Redis Cluster 中的数据是如何分布的？如何确定给定 key 的应该分布到哪个哈希槽中？
Redis Cluster 并没有使用一致性哈希，采用的是 哈希槽分区 ，每一个键值对都属于一个 哈希槽 当客户端发送命令请求的时候，需要先根据 key 通过CRC16算法找到的对应的哈希槽，然后再查询哈希槽和节点的映射关系，即可找到目标节点。而每个master内部维护了哈希槽路由表，即每个master对应的哈希槽值分布。
**题评：** 暂无
::: details 点击查看详细答案
待补充
:::


### 11. Redis Cluster 扩容缩容期间可以提供服务吗？
可以，如果客户端请求的 key 对应的哈希槽已经迁移完成的话，就会返回 重定向错误，告知客户端当前哈希槽是由哪个节点负责，客户端向新节点发送请求并更新缓存的哈希槽分配信息，后续查询将被发送到新节点。
**题评：** 暂无
::: details 点击查看详细答案
待补充
:::


### 12. Redis Cluster 中的节点是怎么进行通信的？
集群中的每个节点都会单独开辟一个TCP通道， 用于节点之间彼此通信。每个节点在固定周期内通过特定规则选择几个节点发送ping消息。接收到ping消息的节点用pong消息作为响应。集群中每个节点通过一定规则挑选要通信的节点， 每个节点可能知道全部节点， 也可能仅知道部分节点， 只要这些节点彼此可以正常通信， 最终它们会达到一致的状态。 当节点出故障、 新节点加入、 主从角色变化、 槽信息变更等事件发生时， 通过不断的ping/pong消息通信， 经过一段时间后所有的节点都会知道整个集群全部节点的最新状态， 从而达到集群状态同步的目的。
**题评：** 暂无
::: details 点击查看详细答案
待补充
:::

### 13. `Redis` 集群架构模式有哪几种？ :star::star::star::three:
- 哨兵模式：哨兵模式也是为了提供高可用而设计的，这种模式中多个`redis`实例，其中一个为主节点，其他为从节点。哨兵们监控着各个节点的状态，当主节点宕机了会从从节点中选出新的节点作为主节点。
- 集群模式：集群模式是为了数据扩展与分片而设计的，这种模式是由多个节点群组成，每个节点群只有一个主节点，每个群负责一部分数据。每个节点群的主节点相互发送心跳，判断其他主节点的状态。

**题评：** 暂无
::: details 点击查看详细答案
`Sentinal` 哨兵模式需要引进哨兵服务器进行状态监督与主选举，着眼于高可用，哨兵不需要和主机一对一，可以多对多。缺点没有解决`master`写的压力。一个`master`多个`slave`。每台机子存储相同的数据。
`Cluster` 着眼于扩展性，内存不足可以分片存储。一个主从簇中每台节点存储不同的数据，采用多主多从解决了`master`写的压力。
:::

 